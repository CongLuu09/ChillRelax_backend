<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chill Relax Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      display: flex;
      font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
      padding-top: 60px !important;
    }
    .sidebar {
      height: 100vh;
      width: 240px;
      background: linear-gradient(135deg, #212529 80%, #0d6efd 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
      position: fixed;
      top: 0; left: 0;
      overflow-y: auto;
      box-shadow: 2px 0 16px 0 rgba(13,110,253,0.15);
      z-index: 10;
      border-top-right-radius: 32px;
      border-bottom-right-radius: 32px;
    }
    .sidebar-logo {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .sidebar-logo img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      box-shadow: 0 0.25rem 1rem #0d6efd33;
      background: #fff;
      object-fit: cover;
      border: 3px solid #fff;
      margin-bottom: 0.5rem;
    }
    .sidebar h3 {
      font-weight: 700;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.7rem;
      letter-spacing: 1px;
      user-select: none;
      color: #fff;
      text-shadow: 0 2px 8px #0d6efd44;
    }
    .sidebar a {
      padding: 14px 28px;
      font-size: 1.08rem;
      color: #e0e7ff;
      text-decoration: none;
      transition: background 0.25s, color 0.25s, font-weight 0.2s;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      user-select: none;
      border-radius: 0 30px 30px 0;
      margin-bottom: 2px;
      font-weight: 500;
    }
    .sidebar a:hover, .sidebar a.active {
      background: linear-gradient(90deg,#0d6efd 60%,#5fa8ff 100%);
      color: #fff !important;
      font-weight: 700;
      box-shadow: 2px 4px 16px #0d6efd22;
      transform: translateX(4px) scale(1.04);
    }
    .sidebar a.btn-api-docs {
      margin: 1.5rem 18px 0 18px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 25px;
      background: #fff;
      color: #0d6efd;
      border: 2px solid #0d6efd;
      font-weight: 600;
      justify-content: center;
      box-shadow: 0 2px 8px #0d6efd11;
      transition: background 0.2s, color 0.2s;
    }
    .sidebar a.btn-api-docs:hover {
      background: #0d6efd;
      color: #fff;
      border-color: #fff;
    }
    .content {
      margin-left: 240px;
      padding: 2.5rem 3rem;
      flex-grow: 1;
      background: transparent;
      min-height: 100vh;
      transition: margin-left 0.2s;
    }
    .content h1 {
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 2.7rem;
      user-select: none;
      color: #0d6efd;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #0d6efd11;
    }
    .content p {
      font-size: 1.18rem;
      color: #6c757d;
      margin-bottom: 2rem;
      user-select: none;
      font-weight: 500;
    }
    .dashboard-cards {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 2.5rem;
      justify-content: flex-start;
    }
    .dashboard-card {
      flex: 1 1 260px;
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px 0 rgba(13,110,253,0.08);
      padding: 2rem 2.2rem;
      cursor: pointer;
      transition: transform 0.18s, box-shadow 0.18s, background 0.22s;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #495057;
      border: 2.5px solid transparent;
      position: relative;
      overflow: hidden;
    }
    .dashboard-card.sounds { color: #0d6efd; background: linear-gradient(135deg,#e0e7ff 60%,#fff 100%);}
    .dashboard-card.mixes { color: #198754; background: linear-gradient(135deg,#e6f4ea 60%,#fff 100%);}
    .dashboard-card.uploads { color: #ffc107; background: linear-gradient(135deg,#fffbe6 60%,#fff 100%);}
    .dashboard-card:hover {
      background: linear-gradient(135deg,#e0e7ff 80%,#fff 100%);
      transform: translateY(-8px) scale(1.045);
      box-shadow: 0 8px 32px 0 rgba(13,110,253,0.18);
      color: #0d6efd;
      border: 2.5px solid #0d6efd33;
    }
    .dashboard-card h5 {
      font-size: 1.35rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
      letter-spacing: 0.5px;
    }
    .dashboard-card .stat-number {
      font-size: 3.2rem;
      font-weight: 800;
      color: inherit;
      user-select: text;
      margin-top: 0.2rem;
      text-shadow: 0 2px 8px #0d6efd22;
    }
    section.details {
      margin-top: 2.5rem;
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px 0 rgba(13,110,253,0.08);
      padding: 2rem 2.2rem;
      user-select: none;
      border: 1.5px solid #e0e7ff;
    }
    section.details h2 {
      font-weight: 700;
      margin-bottom: 1.2rem;
      font-size: 1.8rem;
      color: #212529;
      letter-spacing: 0.5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      user-select: text;
      background: #fff;
      border-radius: 0.8rem;
      overflow: hidden;
      box-shadow: 0 2px 8px #0d6efd11;
    }
    thead tr {
      background: linear-gradient(90deg,#0d6efd 60%,#5fa8ff 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1.08rem;
    }
    th, td {
      padding: 0.85rem 1.1rem;
      border-bottom: 1px solid #dee2e6;
      text-align: left;
      vertical-align: middle;
    }
    tbody tr:hover {
      background-color: #e9f0ff;
      transition: background 0.18s;
    }
    #btnRefresh {
      margin-bottom: 2rem;
      user-select: none;
      font-weight: 600;
      border-radius: 24px;
      padding: 0.6rem 1.5rem;
      box-shadow: 0 2px 8px #0d6efd11;
      letter-spacing: 0.5px;
    }
    #loadingSpinner {
      display: none;
      margin-left: 1rem;
      width: 24px;
      height: 24px;
      border: 3px solid #0d6efd;
      border-top: 3px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .modal .form-label { font-weight: 600; }
    .modal .form-control:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13,110,253,.18); }
    .btn-edit-user { margin-right: 0.5rem; }
    .modal-content {
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px 0 rgba(13,110,253,0.12);
    }
    .modal-header {
      border-bottom: 1.5px solid #e0e7ff;
    }
    .modal-footer {
      border-top: 1.5px solid #e0e7ff;
    }
    @media (max-width: 991px) {
      .sidebar { width: 90px; }
      .sidebar a { font-size: 0.92rem; padding: 10px 10px; }
      .content { margin-left: 90px; padding: 1.5rem 0.5rem; }
      .dashboard-cards { flex-direction: column; gap: 1.2rem; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .content { margin-left: 0; padding: 1rem 0.2rem; }
      .dashboard-cards { flex-direction: column; gap: 1rem; }
    }

    .admin-header {
      background: linear-gradient(90deg,#0d6efd 60%,#5fa8ff 100%);
      position: fixed;
      top: 0; left: 240px; right: 0;
      z-index: 20;
      height: 60px;
      border-bottom-left-radius: 24px;
      box-shadow: 0 2px 16px #0d6efd22;
      transition: left 0.2s;
    }
    @media (max-width: 991px) {
      .admin-header { left: 90px; }
    }
    @media (max-width: 768px) {
      .admin-header { left: 0; }
    }
    .admin-header img {
      border: 2.5px solid #fff;
      box-shadow: 0 2px 8px #0d6efd22;
    }
    .btn {
      font-family: 'Montserrat', 'Segoe UI', sans-serif;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body>
  <header class="admin-header d-flex align-items-center justify-content-between px-4 py-2 shadow-sm"
    style="background:linear-gradient(90deg,#0d6efd 60%,#5fa8ff 100%);position:fixed;top:0;left:220px;right:0;z-index:20;height:60px;">
    <div>
      <span class="fw-bold fs-4 text-white">Chill Relax Admin</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span class="fw-semibold text-white">Xin ch√†o, <span id="adminName">Admin</span></span>
      <img src="images/fileImage-1748511502715-866974007.png" alt="Admin Avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;">
      <button class="btn btn-light btn-sm" onclick="logoutAdmin()"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </header>

  <nav class="sidebar">
    <div class="sidebar-logo">
      <img src="images/fileImage-1748510717131-857231684.png" alt="Logo" />
    </div>
    <h3>Chill Relax</h3>
    <a href="#" class="active" id="menuDashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a href="#" id="menuSounds"><i class="bi bi-music-note-list"></i> Manage Sounds</a>
    <a href="#" id="menuMixes"><i class="bi bi-sliders"></i> Manage Mixes</a>
    <a href="#" id="menuUploads"><i class="bi bi-upload"></i> Upload Files</a>
    <a href="#" id="menuUsers"><i class="bi bi-people"></i> Manage Users</a>
    <a href="#"><i class="bi bi-gear"></i> Settings</a>
    <a href="/api-docs" class="btn-api-docs"><i class="bi bi-link-45deg"></i> API Docs</a>
  </nav>

  <main class="content">
    <h1 id="mainTitle">Welcome to Chill Relax Admin Dashboard</h1>
    <p id="mainDesc">This is your admin panel where you can manage sounds, mixes, uploads and users.</p>

    <section id="dashboardSection">
      <button id="btnRefresh" class="btn btn-primary" title="Reload all stats and detail table">
        Refresh Stats
        <span id="loadingSpinner"></span>
      </button>
      <section class="dashboard-cards">
        <div id="cardTotalSounds" class="dashboard-card sounds" title="Click to see all sounds">
          <div style="font-size:2.5rem;"><i class="bi bi-music-note-beamed"></i></div>
          <h5>Total Sounds</h5>
          <div class="stat-number" id="totalSounds">--</div>
        </div>
        <div id="cardTotalMixes" class="dashboard-card mixes" title="Click to see all mixes">
          <div style="font-size:2.5rem;"><i class="bi bi-sliders"></i></div>
          <h5>Total Mixes</h5>
          <div class="stat-number" id="totalMixes">--</div>
        </div>
        <div id="cardUploadsPending" class="dashboard-card uploads" title="Click to upload new sound">
          <div style="font-size:2.5rem;"><i class="bi bi-cloud-arrow-up"></i></div>
          <h5>Uploads Pending</h5>
          <div class="stat-number" id="pendingUploads">--</div>
        </div>
      </section>
      <section class="details" aria-live="polite" aria-atomic="true">
        <h2>Details</h2>
        <table class="table table-striped" id="detailsTable" role="table" aria-label="Details data table">
          <thead>
            <tr id="detailsTableHeader"></tr>
          </thead>
          <tbody id="detailsTableBody"></tbody>
        </table>
      </section>
    </section>

    <section id="usersSection" style="display:none;">
      <h2>Users</h2>
      <button class="btn btn-success mb-3" id="btnAddUser"><i class="bi bi-person-plus"></i> Add User</button>
      <table class="table table-striped align-middle" id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </section>
  </main>

  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addUserForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="addUsername" name="username" required>
          </div>
          <div class="mb-3">
            <label for="addEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="addEmail" name="email">
          </div>
          <div class="mb-3">
            <label for="addRole" class="form-label">Role</label>
            <select class="form-select" id="addRole" name="role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="addPassword" name="password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editUserForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUserId" name="id">
          <div class="mb-3">
            <label for="editUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="editUsername" name="username" required>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" name="email">
          </div>
          <div class="mb-3">
            <label for="editRole" class="form-label">Role</label>
            <select class="form-select" id="editRole" name="role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="uploadForm" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Sound</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="name" class="form-label">Sound Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category" required>
              <option value="">-- Select Category --</option>
              <option value="Nature & Rain">Nature & Rain</option>
              <option value="Fire Sounds">Fire Sounds</option>
              <option value="City Sounds">City Sounds</option>
              <option value="Cafe & Chill">Cafe & Chill</option>
              <option value="Home Sounds">Home Sounds</option>
              <option value="Instrument Sounds">Instrument Sounds</option>
              <option value="Animal Sounds">Animal Sounds</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="fileSound" class="form-label">Sound File</label>
            <input type="file" class="form-control" id="fileSound" name="fileSound" accept="audio/*" required>
          </div>
          <div class="mb-3">
            <label for="fileImage" class="form-label">Image File</label>
            <input type="file" class="form-control" id="fileImage" name="fileImage" accept="image/*" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Upload</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user || user.role !== 'admin') {
        window.location.href = 'login.html';
      }
    });

    const loadingSpinner = document.getElementById('loadingSpinner');
    let currentDetailType = null; 

    async function fetchTotalSounds() {
      try {
        const res = await fetch('/api/sounds');
        if (!res.ok) throw new Error('Failed to fetch sounds');
        const json = await res.json();
        if (json.data) return json.data;
        if (Array.isArray(json)) return json;
        return [];
      } catch (error) {
        console.error('Error fetching sounds:', error);
        return [];
      }
    }

    async function fetchTotalMixes() {
      try {
        const res = await fetch('/api/mix/all');
        if (!res.ok) throw new Error('Failed to fetch mixes');
        const json = await res.json();
        if (Array.isArray(json)) return json;
        if (json.data) return json.data;
        return [];
      } catch (error) {
        console.error('Error fetching mixes:', error);
        return [];
      }
    }

    async function fetchPendingUploads() {
      try {
        const res = await fetch('/api/uploads/pending');
        if (!res.ok) throw new Error('Failed to fetch pending uploads');
        const json = await res.json();
        if (json.data) return json.data;
        if (Array.isArray(json)) return json;
        return [];
      } catch (error) {
        console.error('Error fetching pending uploads:', error);
        return [];
      }
    }

    function renderTable(headers, data, renderRow) {
      const thead = document.getElementById('detailsTableHeader');
      const tbody = document.getElementById('detailsTableBody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        thead.appendChild(th);
      });

      if (data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${headers.length}" class="text-center text-muted">No data available</td>`;
        tbody.appendChild(tr);
        return;
      }

      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = renderRow(item);
        tbody.appendChild(tr);
      });
    }

    async function loadStats() {
      loadingSpinner.style.display = 'inline-block';
      const sounds = await fetchTotalSounds();
      const mixes = await fetchTotalMixes();
      const uploadsPending = await fetchPendingUploads();

      document.getElementById('totalSounds').textContent = sounds.length;
      document.getElementById('totalMixes').textContent = mixes.length;
      document.getElementById('pendingUploads').textContent = uploadsPending.length;

      if (currentDetailType === 'sounds') await showSoundsDetails(sounds);
      else if (currentDetailType === 'mixes') await showMixesDetails(mixes);
      else if (currentDetailType === 'uploads') await showUploadsPendingDetails();

      loadingSpinner.style.display = 'none';
    }

    async function showSoundsDetails(preloadedData) {
      currentDetailType = 'sounds';
      document.getElementById('mainTitle').textContent = 'Manage Sounds';
      document.getElementById('mainDesc').textContent = 'View and manage all sounds in the system.';
      document.getElementById('dashboardSection').style.display = '';
      document.getElementById('usersSection').style.display = 'none';

      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById('menuSounds').classList.add('active');
      const sounds = preloadedData || await fetchTotalSounds();
      renderTable(
        ['ID', 'Name', 'Category', 'Created At'],
        sounds,
        (item) => `
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${new Date(item.createdAt).toLocaleString()}</td>
        `
      );
    }

    async function showMixesDetails(preloadedData) {
      currentDetailType = 'mixes';
      document.getElementById('mainTitle').textContent = 'Manage Mixes';
      document.getElementById('mainDesc').textContent = 'View and manage all mixes in the system.';
      document.getElementById('dashboardSection').style.display = '';
      document.getElementById('usersSection').style.display = 'none';
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById('menuMixes').classList.add('active');
      const mixes = preloadedData || await fetchTotalMixes();
      renderTable(
        ['ID', 'Name', 'Device ID', 'Sound Count', 'Created At'],
        mixes,
        (item) => `
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.deviceId}</td>
          <td>${item.soundIds.length}</td>
          <td>${new Date(item.createdAt).toLocaleString()}</td>
        `
      );
    }

    async function showUploadsPendingDetails(preloadedData) {
      currentDetailType = 'uploads';
      document.getElementById('mainTitle').textContent = 'Pending Uploads';
      document.getElementById('mainDesc').textContent = 'View and manage all pending uploads.';
      document.getElementById('dashboardSection').style.display = '';
      document.getElementById('usersSection').style.display = 'none';
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById('menuUploads').classList.add('active');
      const uploads = preloadedData || await fetchPendingUploads();
      renderTable(
        ['ID', 'File Name', 'Status', 'Uploaded At'],
        uploads,
        (item) => `
          <td>${item.id}</td>
          <td>${item.fileName || item.name || ''}</td>
          <td>${item.status || 'Pending'}</td>
          <td>${item.uploadedAt ? new Date(item.uploadedAt).toLocaleString() : ''}</td>
        `
      );
    }

    const currentUserRole = 'admin';

    async function loadUsers() {
      document.getElementById('mainTitle').textContent = 'Manage Users';
      document.getElementById('mainDesc').textContent = 'View and manage all users in the system.';
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('usersSection').style.display = '';
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById('menuUsers').classList.add('active');
      try {
        const res = await fetch('/api/users');
        const users = await res.json();
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        users.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.email || ''}</td>
            <td>${user.role}</td>
            <td>${user.createdAt ? new Date(user.createdAt).toLocaleString() : ''}</td>
            <td>
              <button class="btn btn-sm btn-primary btn-edit-user" data-id="${user.id}" data-username="${user.username}" data-email="${user.email || ''}" data-role="${user.role}"><i class="bi bi-pencil"></i> Edit</button>
              <button class="btn btn-sm btn-danger btn-delete-user" data-id="${user.id}"><i class="bi bi-trash"></i> Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        document.querySelectorAll('.btn-delete-user').forEach(btn => {
          btn.addEventListener('click', async function() {
            if (currentUserRole !== 'admin') {
              alert('Ch·ªâ admin m·ªõi ƒë∆∞·ª£c x√≥a user!');
              return;
            }
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user n√†y?')) {
              const id = this.getAttribute('data-id');
              const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
              if (res.ok) {
                alert('ƒê√£ x√≥a user!');
                loadUsers();
              } else {
                alert('X√≥a user th·∫•t b·∫°i!');
              }
            }
          });
        });

        document.querySelectorAll('.btn-edit-user').forEach(btn => {
          btn.addEventListener('click', function() {
            if (currentUserRole !== 'admin') {
              alert('Ch·ªâ admin m·ªõi ƒë∆∞·ª£c s·ª≠a user!');
              return;
            }
            document.getElementById('editUserId').value = this.getAttribute('data-id');
            document.getElementById('editUsername').value = this.getAttribute('data-username');
            document.getElementById('editEmail').value = this.getAttribute('data-email');
            document.getElementById('editRole').value = this.getAttribute('data-role');
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
          });
        });
      } catch (err) {
        alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch user!');
      }
    }

    document.getElementById('btnAddUser').addEventListener('click', () => {
      document.getElementById('addUserForm').reset();
      const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
      modal.show();
    });

    document.getElementById('addUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      try {
        const res = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          alert('Th√™m user th√†nh c√¥ng!');
          bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
          loadUsers();
        } else {
          const errMsg = await res.text();
          alert('Th√™m user th·∫•t b·∫°i!\n' + errMsg);
        }
      } catch (err) {
        alert('Th√™m user th·∫•t b·∫°i!\n' + err.message);
      }
    });

    document.getElementById('editUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const username = document.getElementById('editUsername').value;
      const email = document.getElementById('editEmail').value;
      const role = document.getElementById('editRole').value;
      try {
        const res = await fetch(`/api/users/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, role, currentUserRole })
        });
        if (res.ok) {
          alert('S·ª≠a user th√†nh c√¥ng!');
          bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
          loadUsers();
        } else {
          const errMsg = await res.text();
          alert('S·ª≠a user th·∫•t b·∫°i!\n' + errMsg);
        }
      } catch (err) {
        alert('S·ª≠a user th·∫•t b·∫°i!\n' + err.message);
      }
    });

    document.getElementById('menuDashboard').addEventListener('click', () => {
      document.getElementById('mainTitle').textContent = 'Welcome to Chill Relax Admin Dashboard';
      document.getElementById('mainDesc').textContent = 'This is your admin panel where you can manage sounds, mixes, uploads and users.';
      document.getElementById('dashboardSection').style.display = '';
      document.getElementById('usersSection').style.display = 'none';
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      document.getElementById('menuDashboard').classList.add('active');
    });
    document.getElementById('menuUsers').addEventListener('click', loadUsers);
    document.getElementById('menuSounds').addEventListener('click', () => showSoundsDetails());
    document.getElementById('menuMixes').addEventListener('click', () => showMixesDetails());
    document.getElementById('menuUploads').addEventListener('click', () => showUploadsPendingDetails());

    document.getElementById('cardTotalSounds').addEventListener('click', () => showSoundsDetails());
    document.getElementById('cardTotalMixes').addEventListener('click', () => showMixesDetails());
    document.getElementById('cardUploadsPending').addEventListener('click', () => {
      const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
      uploadModal.show();
    });

    document.getElementById('btnRefresh').addEventListener('click', loadStats);

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      if (
        !formData.get('fileSound') ||
        !formData.get('fileImage') ||
        !formData.get('name') ||
        !formData.get('category')
      ) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß file nh·∫°c, file ·∫£nh, nh·∫≠p t√™n sound v√† ch·ªçn category!');
        return;
      }
      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) {
          const errMsg = await res.text();
          alert('Upload th·∫•t b·∫°i!\n' + errMsg);
          throw new Error('Upload failed: ' + errMsg);
        }
        alert('Upload th√†nh c√¥ng!');
        bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
        await loadStats();
        await showSoundsDetails();
      } catch (err) {
        alert('Upload th·∫•t b·∫°i!\n' + err.message);
      }
    });

    function logoutAdmin() {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    document.addEventListener('DOMContentLoaded', loadStats);
  </script>
</body>
</html>